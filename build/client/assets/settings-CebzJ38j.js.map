{"version":3,"file":"settings-CebzJ38j.js","sources":["../../../app/components/profile/AvatarUpload.tsx","../../../app/routes/settings.tsx"],"sourcesContent":["import { useState, useRef } from 'react';\n\ninterface AvatarUploadProps {\n  currentAvatarUrl?: string | null;\n  username: string;\n  onUploadComplete?: (avatarUrl: string) => void;\n}\n\nexport function AvatarUpload({\n  currentAvatarUrl,\n  username,\n  onUploadComplete,\n}: AvatarUploadProps) {\n  const [previewUrl, setPreviewUrl] = useState<string | null>(currentAvatarUrl || null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    // Validate file size (5MB)\n    const MAX_SIZE = 5 * 1024 * 1024;\n    if (file.size > MAX_SIZE) {\n      setError('File size exceeds 5MB limit');\n      return;\n    }\n\n    // Validate file type\n    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];\n    if (!validTypes.includes(file.type)) {\n      setError('Invalid file type. Only JPEG, PNG, and WebP are allowed');\n      return;\n    }\n\n    // Clear error\n    setError(null);\n\n    // Create preview\n    const reader = new FileReader();\n    reader.onloadend = () => {\n      setPreviewUrl(reader.result as string);\n    };\n    reader.readAsDataURL(file);\n\n    // Upload file\n    handleUpload(file);\n  };\n\n  const handleUpload = async (file: File) => {\n    setIsUploading(true);\n    setError(null);\n\n    try {\n      const formData = new FormData();\n      formData.append('avatar', file);\n\n      const response = await fetch('/api/profile/avatar', {\n        method: 'POST',\n        body: formData,\n      });\n\n      // Check if response is a redirect (user not authenticated)\n      if (response.redirected || response.type === 'opaqueredirect') {\n        throw new Error('Please log in to upload avatar');\n      }\n\n      // Try to parse response as JSON\n      let data;\n      try {\n        data = await response.json();\n      } catch (jsonError) {\n        // If JSON parsing fails, it might be an HTML error page\n        throw new Error('Unexpected response format. Please try again.');\n      }\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Upload failed');\n      }\n\n      setPreviewUrl(data.avatarUrl);\n      if (onUploadComplete) {\n        onUploadComplete(data.avatarUrl);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Upload failed');\n      setPreviewUrl(currentAvatarUrl || null);\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handleClick = () => {\n    fileInputRef.current?.click();\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center space-x-4\">\n        {/* Avatar Preview */}\n        <div className=\"relative\">\n          {previewUrl ? (\n            <img\n              src={previewUrl}\n              alt=\"Avatar\"\n              className=\"w-24 h-24 rounded-full object-cover\"\n            />\n          ) : (\n            <div className=\"w-24 h-24 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold text-3xl\">\n              {username.charAt(0).toUpperCase()}\n            </div>\n          )}\n\n          {isUploading && (\n            <div className=\"absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center\">\n              <div className=\"text-white text-sm\">Uploading...</div>\n            </div>\n          )}\n        </div>\n\n        {/* Upload Button */}\n        <div>\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\"image/jpeg,image/jpg,image/png,image/webp\"\n            onChange={handleFileSelect}\n            className=\"hidden\"\n          />\n          <button\n            type=\"button\"\n            onClick={handleClick}\n            disabled={isUploading}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-medium\"\n          >\n            {isUploading ? 'Uploading...' : 'Change Avatar'}\n          </button>\n          <p className=\"mt-2 text-sm text-gray-500\">\n            JPEG, PNG, or WebP. Max 5MB.\n          </p>\n        </div>\n      </div>\n\n      {/* Error Message */}\n      {error && (\n        <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg\">\n          <p className=\"text-red-600 text-sm\">{error}</p>\n        </div>\n      )}\n    </div>\n  );\n}\n","import { useState } from 'react';\nimport { useLoaderData, useActionData, Form, useNavigate, useRevalidator } from 'react-router';\nimport { requireAuth } from '~/lib/auth/session';\nimport { getUserById, updateProfile } from '~/models/user/user.model';\nimport { updateProfileSchema } from '~/models/user/user.schema';\nimport { AvatarUpload } from '~/components/profile/AvatarUpload';\nimport type { Route } from './+types/settings';\n\nexport async function loader({ request }: Route.LoaderArgs) {\n  const userId = await requireAuth(request);\n  const profile = await getUserById(userId);\n\n  if (!profile) {\n    throw new Response('Profile not found', { status: 404 });\n  }\n\n  return { profile };\n}\n\nexport async function action({ request }: Route.ActionArgs) {\n  try {\n    const userId = await requireAuth(request);\n    const formData = await request.formData();\n\n    const bio = formData.get('bio') as string;\n\n    // Validate (only bio field - avatarUrl is handled separately by AvatarUpload component)\n    const validated = updateProfileSchema.parse({ bio });\n\n    // Update profile\n    const updatedProfile = await updateProfile(userId, validated);\n\n    if (!updatedProfile) {\n      return { error: 'Failed to update profile' };\n    }\n\n    return { success: true, profile: updatedProfile };\n  } catch (error) {\n    if (error instanceof Error) {\n      return { error: error.message };\n    }\n    return { error: 'Failed to update profile' };\n  }\n}\n\nexport default function SettingsPage() {\n  const { profile } = useLoaderData<typeof loader>();\n  const actionData = useActionData<typeof action>();\n  const navigate = useNavigate();\n  const revalidator = useRevalidator();\n\n  const [bio, setBio] = useState(profile.bio || '');\n\n  const bioLength = bio.length;\n  const bioRemaining = 160 - bioLength;\n  const isBioValid = bioLength <= 160;\n\n  return (\n    <div className=\"max-w-2xl mx-auto\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <h1 className=\"text-2xl font-bold text-gray-900 mb-6\">Profile Settings</h1>\n\n        {/* Avatar Upload Section (outside form) */}\n        <div className=\"mb-6\">\n          <label className=\"block text-sm font-medium text-gray-700 mb-4\">\n            Profile Picture\n          </label>\n          <AvatarUpload\n            currentAvatarUrl={profile.avatarUrl}\n            username={profile.username}\n            onUploadComplete={() => revalidator.revalidate()}\n          />\n        </div>\n\n        <Form method=\"post\" className=\"space-y-6\">\n\n          {/* Bio */}\n          <div>\n            <label htmlFor=\"bio\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Bio\n            </label>\n            <textarea\n              id=\"bio\"\n              name=\"bio\"\n              value={bio}\n              onChange={(e) => setBio(e.target.value)}\n              placeholder=\"Tell us about yourself...\"\n              className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none ${\n                !isBioValid ? 'border-red-500' : 'border-gray-300'\n              }`}\n              rows={4}\n              maxLength={200}\n            />\n            <div className=\"flex justify-between items-center mt-1\">\n              <span className={`text-sm ${bioRemaining < 0 ? 'text-red-600' : 'text-gray-500'}`}>\n                {bioRemaining} characters remaining\n              </span>\n            </div>\n          </div>\n\n          {/* Success/Error Messages */}\n          {actionData && 'success' in actionData && actionData.success && (\n            <div className=\"p-4 bg-green-50 border border-green-200 rounded-lg\">\n              <p className=\"text-green-600 text-sm\">Profile updated successfully!</p>\n            </div>\n          )}\n\n          {actionData && 'error' in actionData && (\n            <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg\">\n              <p className=\"text-red-600 text-sm\">{actionData.error}</p>\n            </div>\n          )}\n\n          {/* Action Buttons */}\n          <div className=\"flex gap-3\">\n            <button\n              type=\"submit\"\n              disabled={!isBioValid}\n              className=\"flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition\"\n            >\n              Save Changes\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => navigate(`/${profile.username}`)}\n              className=\"px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition\"\n            >\n              Cancel\n            </button>\n          </div>\n        </Form>\n      </div>\n    </div>\n  );\n}\n"],"names":["AvatarUpload","currentAvatarUrl","username","onUploadComplete","previewUrl","setPreviewUrl","useState","isUploading","setIsUploading","error","setError","fileInputRef","useRef","handleFileSelect","event","file","MAX_SIZE","reader","handleUpload","formData","response","data","err","handleClick","jsxs","jsx","settings","_UNSAFE_withComponentProps","profile","useLoaderData","actionData","useActionData","navigate","useNavigate","revalidator","useRevalidator","bio","setBio","bioLength","length","bioRemaining","isBioValid","className","children","avatarUrl","revalidate","Form","method","htmlFor","id","name","value","onChange","e","target","placeholder","rows","maxLength","success","type","disabled","onClick"],"mappings":"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"}